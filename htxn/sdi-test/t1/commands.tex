%\usepakage{newfile}

\usepackage{hyperref}

\usepackage{etoolbox}

\usepackage{zref-user}

\newwrite\sdiFile
\immediate\openout\sdiFile=\jobname.sdi.txt

\newcommand{\p}[1]{

\vspace{10pt}#1}

\newif\iftabng
\tabngfalse


\usepackage{letltxmacro}
\LetLtxMacro{\oldmmsemi}{\;}
\LetLtxMacro{\oldtbplus}{\+}
\LetLtxMacro{\oldtbgt}{\>}
\LetLtxMacro{\oldmmgt}{\+}

\newcommand{\+}{\iftabng\oldtbplus\else\sss\fi}

\renewcommand{\>}{\iftabng\oldtbplus\else
\ifmmode\oldmmgt\else\sse\sss\fi\fi}

%\renewcommand{\>}{\sse\sss}

\renewcommand{\;}{\relax\ifmmode\oldmmsemi\else\sse\fi}

\newcommand{\writeSDI}[1]{\immediate\write\sdiFile#1}

\newcommand{\emblink}[2]{\href{\#sdi:#1--#2}{\#sdi:#1--#2}}

%\newcount\sdiCounter
%\def\advsdiCounter{\global\advance\sdiCounter by1}

%\newcount\sdiCounterP
%\def\advsdiCounterP{\global\advance\sdiCounterP by1}

%\newcounter{sdiCounter}
\newcounter{sdiCounterP}[page]
\newcounter{sdiCounter}

\def\topt#1{\expandafter\the\dimexpr\dimexpr#1sp\relax\relax}

\makeatletter
%\catcode`\*=10
\newcommand{\sss}{%
\stepcounter{sdiCounterP}
\stepcounter{sdiCounter}
\pdfsavepos\write\sdiFile{!/ SDI_Sentence_Start} 
\write\sdiFile\expandafter{\expandafter$%
\expandafter i\expandafter:%
\expandafter\space\the\c@sdiCounter}
\write\sdiFile\expandafter{\expandafter$%
\expandafter o\expandafter:%
\expandafter\space\the\c@sdiCounterP}
\write\sdiFile\expandafter{\expandafter$%
\expandafter p\expandafter:%
\expandafter\space\thepage^^J%
$x: \topt\pdflastxpos^^J%
$y: \topt\pdflastypos^^J%
/!^^J%
<<>^^J%
}}
%\catcode`\%=14
\makeatother

\makeatletter
\newcommand{\sse}{%
\pdfsavepos\write\sdiFile{!/ SDI_Sentence_End} 
\write\sdiFile\expandafter{\expandafter$%
\expandafter i\expandafter:%
\expandafter\space\the\c@sdiCounter}
\write\sdiFile\expandafter{\expandafter$%
\expandafter o\expandafter:%
\expandafter\space\the\c@sdiCounterP}
\write\sdiFile\expandafter{\expandafter$%
\expandafter p\expandafter:%
\expandafter\space\thepage^^J%
$x: \topt\pdflastxpos^^J%
$y: \topt\pdflastypos^^J%
/!^^J%
<<>^^J%
}}
\makeatother

