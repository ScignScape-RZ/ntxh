%\usepakage{newfile}

\usepackage{hyperref}

\usepackage{etoolbox}

\usepackage{zref-user}

\newwrite\sdiFile
\immediate\openout\sdiFile=\jobname.sdi.txt

\newcommand{\p}[1]{

\vspace{10pt}#1}

\newif\iftabng
\tabngfalse


\usepackage{letltxmacro}
\LetLtxMacro{\oldmmsemi}{\;}
\LetLtxMacro{\oldtbplus}{\+}
\LetLtxMacro{\oldtbgt}{\>}
\LetLtxMacro{\oldmmgt}{\+}
\LetLtxMacro{\oldtblt}{\>}

\newcommand{\+}{\iftabng\oldtbplus\else\sss\fi}

\renewcommand{\>}{\iftabng\oldtbplus\else
\ifmmode\oldmmgt\else\sse\sss\fi\fi}

\renewcommand{\>}{\sse\sss}

\renewcommand{\;}{\relax\ifmmode\oldmmsemi\else\sse\fi}

\newcommand{\writeSDI}[1]{\immediate\write\sdiFile#1}

\newcommand{\emblink}[2]{\href{\#sdi:#1--#2}{\#sdi:#1--#2}}

%\newcount\sdiCounter
%\def\advsdiCounter{\global\advance\sdiCounter by1}

%\newcount\sdiCounterP
%\def\advsdiCounterP{\global\advance\sdiCounterP by1}

%\newcounter{sdiCounter}
\newcounter{sdiCounterO}[page]
\newcounter{sdiCounter}

\newcounter{sdiCounterPO}[page]
\newcounter{sdiCounterP}

\def\topt#1{\expandafter\the\dimexpr\dimexpr#1sp\relax\relax}


\newcommand{\writeSdiStart}[1]{\write\sdiFile{!/ SDI_#1_Start}}
\newcommand{\writeSdiEnd}[1]{\write\sdiFile{!/ SDI_#1_End}}
\newcommand{\writeSdiValEnd}{\write\sdiFile{/!^^J<<>^^J}}

\newcommand{\fieldmark}[1]{\expandafter$\expandafter#1%
\expandafter:\expandafter\space}

\makeatletter
\newcommand{\fieldmark@i}{\fieldmark{i}}
\newcommand{\fieldmark@o}{\fieldmark{o}}
\newcommand{\fieldmark@s}{\fieldmark{s}}
\newcommand{\fieldmark@p}{\fieldmark{p}}
\newcommand{\fieldmark@e}{\fieldmark{e}}

\newcommand{\sss}{%
\stepcounter{sdiCounterO}
\stepcounter{sdiCounter}
\pdfsavepos\writeSdiStart{Sentence} 
\write\sdiFile\expandafter{\expandafter\fieldmark@i%
\the\c@sdiCounter}
\write\sdiFile\expandafter{\expandafter\fieldmark@o%
\the\c@sdiCounterO}
\write\sdiFile\expandafter{\expandafter\fieldmark@p%
\thepage^^J%
$x: \topt\pdflastxpos^^J%
$y: \topt\pdflastypos}
\writeSdiValEnd}

\newcommand{\sse}{%
\pdfsavepos\writeSdiEnd{Sentence} 
\write\sdiFile\expandafter{\expandafter\fieldmark@i%
\the\c@sdiCounter}
\write\sdiFile\expandafter{\expandafter\fieldmark@o%
\the\c@sdiCounterP}
\write\sdiFile\expandafter{\expandafter\fieldmark@p%
\thepage^^J%
$x: \topt\pdflastxpos^^J%
$y: \topt\pdflastypos}
\writeSdiValEnd}

\newcommand{\sps}{%
\stepcounter{sdiCounterP}
\stepcounter{sdiCounterPO}
\pdfsavepos\writeSdiStart{Paragraph} 
\write\sdiFile\expandafter{\expandafter\fieldmark@i%
	\the\c@sdiCounterP}
\write\sdiFile\expandafter{\expandafter\fieldmark@o%
	\the\c@sdiCounterPO}
\write\sdiFile\expandafter{\expandafter\fieldmark@p%
	\thepage^^J%
	$x: \topt\pdflastxpos^^J%
	$y: \topt\pdflastypos}
\writeSdiValEnd}

\newcommand{\spe}{%
\pdfsavepos\writeSdiEnd{Paragraph} 
\write\sdiFile\expandafter{\expandafter\fieldmark@i%
	\the\c@sdiCounterP}
\write\sdiFile\expandafter{\expandafter\fieldmark@o%
	\the\c@sdiCounterPO}
\write\sdiFile\expandafter{\expandafter\fieldmark@p%
	\thepage^^J%
$x: \topt\pdflastxpos^^J%
$y: \topt\pdflastypos}
\writeSdiValEnd}


\makeatother

